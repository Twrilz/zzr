<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Model Viewer</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" type="image/png" sizes="32x32" href="images/Icon.png">
  <style>
    /* Minimal page-specific styles so the viewer is full screen and controls are usable */
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    .navbar { background: #222; color: #fff; padding: 8px 12px; }
    .navbar ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 12px; }
    .navbar a { color: #fff; text-decoration: none; }
    .navbar a.active { text-decoration: underline; }
    #viewerWrap { position: relative; width: 100%; height: calc(100vh - 48px); background: #111; }
    #modelViewer { width: 100%; height: 100%; display: block; }
    .ui-overlay { position: absolute; top: 12px; right: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
    .ui-overlay button { background: rgba(255,255,255,0.95); border: none; padding: 8px 10px; border-radius: 6px; cursor: pointer; }
    .ui-overlay input[type=file] { display: none; }
    .drop-hint { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #ddd; background: rgba(0,0,0,0.35); padding: 8px 12px; border-radius: 6px; pointer-events: none; z-index: 5; display: none; }
  </style>

  <!-- Import map resolves the bare specifier "three" for examples modules that import from 'three' -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
      "three/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>

<nav class="navbar">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="gallery.html">Gallery</a></li>
    <li><a href="videos.html">Videos</a></li>
    <li><a href="3dviewer.html" class="active">Models</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>
</nav>

<div id="viewerWrap">
  <div id="modelViewer"></div>
  <div class="ui-overlay">
    <label for="fileInput">
      <button id="btnLoad">Load model</button>
    </label>
    <input id="fileInput" type="file" accept=".glb,.gltf" />
    <button id="btnFit">Fit to view</button>
    <button id="btnZoomIn">Zoom in</button>
    <button id="btnZoomOut">Zoom out</button>
  </div>
  <div class="drop-hint" id="dropHint">Drop .glb/.gltf file here to load</div>
</div>

<script type="module">
  // Using the import map above makes the bare specifier 'three' resolvable in the browser.
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
  import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

  // Renderer, scene, camera
  const container = document.getElementById('modelViewer');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;
  container.appendChild(renderer.domElement);

  const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.01, 1000);
  camera.position.set(0, 0.5, 2);

  // Lights
  const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
  hemi.position.set(0, 1, 0);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(5, 10, 7.5);
  scene.add(dir);

  // Controls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.07;
  controls.screenSpacePanning = false;
  controls.minDistance = 0.2;
  controls.maxDistance = 20;

  // Helpers
  const grid = new THREE.GridHelper(10, 10, 0x222222, 0x111111);
  grid.position.y = -1.0;
  scene.add(grid);

  let currentModel = null;
  const loader = new GLTFLoader();

  // Fit camera to object (correct math using tan)
  function frameArea(sizeToFitOnScreen, box, camera) {
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxSize = Math.max(size.x, size.y, size.z);

    const fov = THREE.Math.degToRad(camera.fov);
    const distance = maxSize * sizeToFitOnScreen / (2 * Math.tan(fov / 2));

    // place camera to the corner so object fits
    const direction = new THREE.Vector3(1, 0.6, 1).normalize();
    camera.position.copy(center).addScaledVector(direction, distance);

    camera.near = Math.max(0.01, distance / 100);
    camera.far = distance * 100;
    camera.updateProjectionMatrix();
    camera.lookAt(center);
    controls.target.copy(center);
    controls.update();
  }

  function fitModelToView(object) {
    const box = new THREE.Box3().setFromObject(object);
    if (!box.isEmpty()) frameArea(1.2, box, camera);
  }

  // Load default model from repo if available
  function loadDefaultModel() {
    try {
      loader.load('models/shvan_92.glb', gltf => {
        setModel(gltf.scene);
      }, undefined, err => console.warn('Default model not found or failed to load:', err));
    } catch (e) {
      console.warn('Default model loader failed:', e);
    }
  }

  function setModel(model) {
    if (currentModel) {
      scene.remove(currentModel);
      // dispose geometry/material if you want to free memory (optional)
    }
    currentModel = model;
    // Ensure model cast/receive lights
    model.traverse(node => {
      if (node.isMesh) {
        node.castShadow = true;
        node.receiveShadow = true;
        if (node.material) node.material.needsUpdate = true;
      }
    });
    scene.add(model);
    fitModelToView(model);
  }

  // File input and drag-drop
  const fileInput = document.getElementById('fileInput');
  const dropHint = document.getElementById('dropHint');
  fileInput.addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) loadFile(f);
    fileInput.value = '';
  });

  function loadFile(file) {
    const url = URL.createObjectURL(file);
    loader.load(url, gltf => {
      setModel(gltf.scene);
      URL.revokeObjectURL(url);
    }, undefined, err => {
      console.error('Failed to load file:', err);
      URL.revokeObjectURL(url);
    });
  }

  // Drag & drop
  ['dragenter', 'dragover'].forEach(evt => {
    window.addEventListener(evt, ev => { ev.preventDefault(); dropHint.style.display = 'block'; });
  });
  ['dragleave', 'drop'].forEach(evt => {
    window.addEventListener(evt, ev => { ev.preventDefault(); dropHint.style.display = 'none'; });
  });
  window.addEventListener('drop', ev => {
    const f = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
    if (f) loadFile(f);
  });

  // Zoom helpers (robust and not dependent on OrbitControls internals)
  function zoomBy(factor) {
    const dir = camera.position.clone().sub(controls.target).multiplyScalar(1 / factor);
    camera.position.copy(controls.target).add(dir);
    controls.update();
  }

  document.getElementById('btnFit').addEventListener('click', () => { if (currentModel) fitModelToView(currentModel); });
  document.getElementById('btnZoomIn').addEventListener('click', () => { zoomBy(1.25); });
  document.getElementById('btnZoomOut').addEventListener('click', () => { zoomBy(0.8); });

  // Resize handling
  function onWindowResize() {
    const w = container.clientWidth, h = container.clientHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  }
  window.addEventListener('resize', onWindowResize);

  // ensure initial size is correct
  onWindowResize();

  // Animation loop
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // Init
  loadDefaultModel();

</script>

</body>
</html>
